<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>Seat Reservation Simulator</title>
    <style>
        body {
          font-family: Arial, sans-serif;
          padding: 40px;
          background: #f9f9f9;
        }
        .card {
          background: white;
          padding: 20px;
          width: 440px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
          margin-top: 0;
        }
        .status {
          font-size: 18px;
          margin: 10px 0;
        }
        .waiting { color: #555; }
        .holding { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }

        button {
          margin-top: 8px;
          padding: 10px 14px;
          font-size: 14px;
          cursor: pointer;
          width: 100%;
        }

        .log {
          margin-top: 15px;
          font-size: 13px;
          color: #333;
          background: #eee;
          padding: 10px;
          height: 140px;
          overflow-y: auto;
        }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸŸ ì¢Œì„ ì˜ˆë§¤ ì‹œë®¬ë ˆì´í„°</h2>

    <div>Seat ID: <b id="seatIdText"></b></div>
    <div>User ID: <b id="userIdText"></b></div>

    <div class="status" id="statusText">ìƒíƒœ: INIT</div>
    <div id="queueInfo"></div>
    <div id="ttlInfo"></div>

    <button id="fakeJoinBtn">ê°€ì§œ ìœ ì € 10ëª… ëŒ€ê¸°ì—´ ì¶”ê°€</button>
    <button id="joinBtn">ëŒ€ê¸°ì—´ ì§„ì…</button>
    <button id="reserveBtn" disabled>ì˜ˆì•½ ì‹œë„</button>

    <div class="log" id="logBox"></div>
</div>

<script>
    // ===== ì„¤ì • =====
    const BASE_URL = "http://localhost:8080";
    const SEAT_ID = 3;
    const USER_ID = "user-" + Math.floor(Math.random() * 10000);
    const FAKE_USER_COUNT = 10;

    document.getElementById("seatIdText").innerText = SEAT_ID;
    document.getElementById("userIdText").innerText = USER_ID;

    const statusText = document.getElementById("statusText");
    const queueInfo = document.getElementById("queueInfo");
    const ttlInfo = document.getElementById("ttlInfo");
    const logBox = document.getElementById("logBox");
    const joinBtn = document.getElementById("joinBtn");
    const reserveBtn = document.getElementById("reserveBtn");
    const fakeJoinBtn = document.getElementById("fakeJoinBtn");

    let pollingTimer = null;

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logBox.innerHTML += `[${time}] ${msg}<br/>`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    // ===== ê°€ì§œ ìœ ì € ì£¼ì… =====
    fakeJoinBtn.onclick = async () => {
      log(`ê°€ì§œ ìœ ì € ${FAKE_USER_COUNT}ëª… ëŒ€ê¸°ì—´ ì¶”ê°€ ì‹œì‘`);

      for (let i = 0; i < FAKE_USER_COUNT; i++) {
        const fakeUserId = `fake-user-${Date.now()}-${i}`;
        await fetch(`${BASE_URL}/seats/${SEAT_ID}/queue`, {
          method: "POST",
          headers: { "X-USER-ID": fakeUserId }
        });
      }

      log(`ê°€ì§œ ìœ ì € ${FAKE_USER_COUNT}ëª… ëŒ€ê¸°ì—´ ì¶”ê°€ ì™„ë£Œ`);
    };

    // ===== ëŒ€ê¸°ì—´ ì§„ì… =====
    joinBtn.onclick = async () => {
      log("ëŒ€ê¸°ì—´ ì§„ì… ì‹œë„");

      const res = await fetch(`${BASE_URL}/seats/${SEAT_ID}/queue`, {
        method: "POST",
        headers: { "X-USER-ID": USER_ID }
      });

      if (res.ok) {
        log("ëŒ€ê¸°ì—´ ì§„ì… ì„±ê³µ");
        statusText.innerText = "ìƒíƒœ: WAITING";
        statusText.className = "status waiting";
        startPolling();
        joinBtn.disabled = true;
      } else {
        log("ëŒ€ê¸°ì—´ ì§„ì… ì‹¤íŒ¨");
      }
    };

    // ===== ìƒíƒœ Polling =====
    function startPolling() {
      pollingTimer = setInterval(async () => {
        const res = await fetch(`${BASE_URL}/seats/${SEAT_ID}/queue/status`, {
          headers: { "X-USER-ID": USER_ID }
        });

        if (!res.ok) return;

        const data = await res.json();

        if (data.status === "WAITING") {
          statusText.innerText = "ìƒíƒœ: WAITING";
          statusText.className = "status waiting";

          if (data.ahead != null) {
            queueInfo.innerText =
              `ë‚´ ì• ëŒ€ê¸°ì: ${data.ahead}ëª… / ì „ì²´ ${data.total}ëª…`;

            if (data.estimatedWaitSeconds != null) {
              ttlInfo.innerText =
                data.estimatedWaitSeconds > 0
                  ? `ì˜ˆìƒ ëŒ€ê¸° ì‹œê°„: ì•½ ${data.estimatedWaitSeconds}ì´ˆ`
                  : "ê³§ ì˜ˆë§¤ ê°€ëŠ¥";
            } else {
              ttlInfo.innerText = "";
            }
          } else {
            queueInfo.innerText = "ëŒ€ê¸°ì—´ì— ì—†ìŒ";
            ttlInfo.innerText = "";
          }
        }

        if (data.status === "HOLDING") {
          statusText.innerText = "ìƒíƒœ: HOLDING";
          statusText.className = "status holding";

          queueInfo.innerText = "";
          ttlInfo.innerText = `ë‚¨ì€ ì‹œê°„: ${data.ttlSeconds}ì´ˆ`;

          reserveBtn.disabled = false;
          log("HOLD íšë“, ì˜ˆë§¤ ê°€ëŠ¥");
        }
      }, 500);
    }

    // ===== ì˜ˆì•½ ì‹œë„ =====
    reserveBtn.onclick = async () => {
      log("ì˜ˆì•½ ì‹œë„");

      const res = await fetch(`${BASE_URL}/seats/${SEAT_ID}/reserve`, {
        method: "POST",
        headers: { "X-USER-ID": USER_ID }
      });

      if (res.ok) {
        log("ğŸ‰ ì˜ˆì•½ ì„±ê³µ!");
        statusText.innerText = "ìƒíƒœ: SUCCESS";
        statusText.className = "status holding";
      } else {
        log("âŒ ì˜ˆì•½ ì‹¤íŒ¨ (HOLD ë§Œë£Œ ë˜ëŠ” ì„ ì°©ìˆœ íƒˆë½)");
        statusText.innerText = "ìƒíƒœ: FAILED";
        statusText.className = "status error";
      }

      clearInterval(pollingTimer);
      reserveBtn.disabled = true;
    };
</script>

</body>
</html>
